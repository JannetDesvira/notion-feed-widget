<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"
  />
  <title>Notion Feed Widget</title>
  <style>
    :root{
      --gap: 8px;
      --tileR: 10px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:#fff;
      color:#111;
    }
    .toolbar{
      display:flex; align-items:center; gap:10px;
      padding:12px; border-bottom:1px solid #eee;
      position: sticky; top:0; background:#fff; z-index:2;
    }
    select, button{
      height:32px; border:1px solid #e3e3e3; background:#fafafa;
      border-radius:8px; padding:0 10px; font-size:14px; cursor:pointer;
    }
    button{ display:inline-flex; align-items:center; gap:6px; }

    /* 3-column square grid, like IG/TikTok */
    .grid{
      padding:12px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--gap);
    }
    .card{
      position:relative;
      width:100%;
      padding-top:100%; /* square */
      border-radius: var(--tileR);
      overflow:hidden;
      background:#f2f2f2;
      cursor:pointer;
    }
    .card img, .card video{
      position:absolute; inset:0;
      width:100%; height:100%; object-fit:cover;
    }
    /* bottom-left hover caption */
    .caption{
      position:absolute; left:0; right:0; bottom:0;
      padding:8px 10px;
      color:#fff; font-size:12px; line-height:1.3;
      background:linear-gradient(180deg, rgba(0,0,0,0) 0, rgba(0,0,0,.55) 90%);
      opacity:0; transition:.18s ease;
    }
    .card:hover .caption{ opacity:1; }

    /* --- Lightbox --- */
    .lightbox{ position:fixed; inset:0; background:rgba(0,0,0,.85);
      display:none; align-items:center; justify-content:center; z-index:9999; }
    .lightbox.open{ display:flex; }
    .lb-inner{ width:min(920px, 92vw); max-height:92vh; display:flex; flex-direction:column; gap:10px; }
    .viewer{
      position:relative; background:#000; border-radius:12px; overflow:hidden;
      display:flex; align-items:center; justify-content:center; min-height:60vh;
    }
    .viewer img, .viewer video, .viewer iframe{
      max-width:100%; max-height:80vh; width:auto; height:auto; display:block;
    }
    .lb-head{
      display:flex; align-items:center; justify-content:space-between; color:#fff;
      font-size:14px;
    }
    .lb-controls{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:space-between;
      pointer-events:none;
    }
    .arrow{
      pointer-events:auto;
      background:rgba(0,0,0,.5); border:none; color:#fff; width:40px; height:40px;
      border-radius:999px; cursor:pointer; font-size:18px;
      display:grid; place-items:center; margin:0 8px;
    }
    .close{
      background:transparent; border:none; color:#fff; font-size:20px; cursor:pointer;
    }

    /* scroll bars hidden inside Notion nicely */
    ::-webkit-scrollbar{ width:8px; height:8px }
    ::-webkit-scrollbar-thumb{ background:#ddd; border-radius:999px }
  </style>
</head>
<body>

  <div class="toolbar">
    <label style="font-size:14px">Platform</label>
    <select id="platform">
      <option>All</option>
      <option>Instagram</option>
      <option>TikTok</option>
      <option>Pinterest</option>
    </select>
    <button id="refresh">⟳ Refresh</button>
  </div>

  <div id="grid" class="grid" aria-live="polite"></div>

  <!-- Lightbox -->
  <div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-label="Media viewer">
    <div class="lb-inner">
      <div class="lb-head">
        <div id="lb-title"></div>
        <button class="close" id="lb-close" aria-label="Close">✕</button>
      </div>
      <div class="viewer" id="viewer">
        <div class="lb-controls">
          <button class="arrow" id="prev" aria-label="Previous">‹</button>
          <button class="arrow" id="next" aria-label="Next">›</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const grid = document.getElementById("grid");
    const platformSel = document.getElementById("platform");
    const refreshBtn = document.getElementById("refresh");

    // Lightbox state
    const lb = document.getElementById("lightbox");
    const lbTitle = document.getElementById("lb-title");
    const lbClose = document.getElementById("lb-close");
    const viewer = document.getElementById("viewer");
    const prevBtn = document.getElementById("prev");
    const nextBtn = document.getElementById("next");
    let lbItems = [];   // urls for current card
    let lbIndex = 0;    // current media index

    const fmtDate = (iso) => {
      if (!iso) return "";
      try {
        const d = new Date(iso);
        return d.toLocaleDateString(undefined, { month:"short", day:"numeric", year:"numeric" });
      } catch { return ""; }
    };

    function mediaEl(url){
      if (/\.(mp4|webm|mov)(\?|$)/i.test(url)) {
        const v = document.createElement("video");
        v.src = url; v.controls = true; v.autoplay = true; v.playsInline = true;
        return v;
      }
      if (/canva\.com/.test(url)) {
        // canva embedding can be restricted, so open in a new tab from the lightbox
        const a = document.createElement("a");
        a.href = url; a.target="_blank"; a.rel="noopener";
        a.style.color = "#fff"; a.textContent = "Open Canva design";
        a.style.padding = "16px";
        return a;
      }
      const img = document.createElement("img");
      img.loading = "lazy";
      img.src = url;
      return img;
    }

    function renderLightbox(){
      viewer.innerHTML = "";
      viewer.appendChild(mediaEl(lbItems[lbIndex]));
      prevBtn.style.visibility = lbItems.length > 1 ? "visible" : "hidden";
      nextBtn.style.visibility = lbItems.length > 1 ? "visible" : "hidden";
    }

    function openLightbox(item){
      lbItems = item.media.slice();
      lbIndex = 0;
      lbTitle.textContent = `${fmtDate(item.date)} • ${item.name}`;
      renderLightbox();
      lb.classList.add("open");
    }

    lbClose.onclick = () => lb.classList.remove("open");
    prevBtn.onclick = () => { lbIndex = (lbIndex - 1 + lbItems.length) % lbItems.length; renderLightbox(); };
    nextBtn.onclick = () => { lbIndex = (lbIndex + 1) % lbItems.length; renderLightbox(); };
    lb.addEventListener("click", (e) => { if (e.target === lb) lb.classList.remove("open"); });

    async function fetchItems(){
      const url = new URL(location.href);
      const base = `${url.origin}${url.pathname.replace(/\/$/, "")}/api/notion`;
      const p = platformSel.value || "All";
      const api = `${base}?platform=${encodeURIComponent(p)}`;
      const r = await fetch(api, { cache: "no-store" });
      if (!r.ok) {
        const t = await r.text();
        throw new Error(`Backend error (${r.status}): ${t}`);
      }
      return r.json();
    }

    function render(items){
      grid.innerHTML = "";
      if (!items || !items.length) return;

      items.forEach((it) => {
        const card = document.createElement("div");
        card.className = "card";
        // first media as thumbnail
        const first = it.media[0] || "";
        let thumb;
        if (/\.(mp4|webm|mov)(\?|$)/i.test(first)) {
          thumb = document.createElement("video");
          thumb.src = first; thumb.muted = true; thumb.autoplay = true; thumb.loop = true; thumb.playsInline = true;
        } else {
          thumb = document.createElement("img");
          thumb.src = first; thumb.loading = "lazy";
        }
        card.appendChild(thumb);

        const cap = document.createElement("div");
        cap.className = "caption";
        cap.textContent = `${fmtDate(it.date)} • ${it.name}`;
        card.appendChild(cap);

        card.onclick = () => openLightbox(it);
        grid.appendChild(card);
      });
    }

    async function load(){
      try {
        const { items } = await fetchItems();
        render(items);
      } catch(err){
        grid.innerHTML = `<div style="color:#b00020;padding:12px;background:#fee;border-radius:8px;">${err.message}</div>`;
        console.error(err);
      }
    }

    // initialize from URL ?platform=
    (function syncFromQuery(){
      const q = new URLSearchParams(location.search);
      const qp = (q.get("platform") || "All");
      for (const opt of platformSel.options) {
        if (opt.value.toLowerCase() === qp.toLowerCase()) { platformSel.value = opt.value; break; }
      }
    })();

    platformSel.onchange = () => {
      const q = new URLSearchParams(location.search);
      q.set("platform", platformSel.value);
      history.replaceState(null, "", `?${q.toString()}`);
      load();
    };
    refreshBtn.onclick = load;

    load();
  </script>
</body>
</html>
