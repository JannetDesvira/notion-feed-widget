<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Notion Feed Widget</title>
  <style>
    :root { --gap: 10px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; }
    .controls { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
    select, button { padding:6px 10px; border:1px solid #ddd; border-radius:6px; background:#fff; }
    button { cursor:pointer; }
    .error { background:#ffe2e2; color:#b00020; padding:10px; border-radius:8px; margin:12px 0; }
    .grid {
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--gap);
    }
    .card {
      position:relative;
      border-radius:12px;
      overflow:hidden;
      background:#f8f8f8;
      border:1px solid #eee;
      aspect-ratio: 1 / 1;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .card img, .card iframe {
      width:100%; height:100%; object-fit:cover; border:0;
    }
    .pin {
      position:absolute; top:6px; left:6px;
      background:#111; color:#fff; font-size:12px; padding:2px 6px; border-radius:999px;
      opacity:.85;
    }
    .meta {
      font-size:12px; color:#555; margin-top:4px; text-align:center;
    }
  </style>
</head>
<body>
  <div class="controls">
    <label>Platform</label>
    <select id="platform">
      <option value="All">All</option>
      <option value="Instagram">Instagram</option>
      <option value="TikTok">TikTok</option>
      <option value="Pinterest">Pinterest</option>
      <!-- add/remove to match your Notion Select options exactly -->
    </select>
    <button id="refresh">⟳ Refresh</button>
  </div>

  <div id="err" class="error" style="display:none;"></div>
  <div id="grid" class="grid"></div>

  <script>
    const grid = document.getElementById('grid');
    const errBox = document.getElementById('err');
    const platformSelect = document.getElementById('platform');
    const refreshBtn = document.getElementById('refresh');

    let allItems = [];

    async function fetchItems() {
      errBox.style.display = 'none';
      grid.innerHTML = '';
      try {
        const res = await fetch('/api/notion', { cache: 'no-store' });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`Backend error: ${text}`);
        }
        const data = await res.json();
        allItems = Array.isArray(data.items) ? data.items : [];
        render();
      } catch (e) {
        errBox.textContent = e.message || 'Unknown error';
        errBox.style.display = 'block';
      }
    }

    function render() {
      const selected = platformSelect.value || 'All';
      const items = allItems.filter(it => selected === 'All' || it.platform === selected);

      grid.innerHTML = items.map(it => {
        // first media only for the grid card; (lightbox can be added later)
        const first = (it.media && it.media[0]) || '';
        const isVideo = first.endsWith('.mp4') || first.includes('video');
        const isCanva = /canva\.com/.test(first);

        let mediaEl = '';
        if (isCanva) {
          mediaEl = `<iframe src="${first}" loading="lazy"></iframe>`;
        } else if (isVideo) {
          mediaEl = `<video src="${first}" autoplay muted loop playsinline></video>`;
        } else {
          mediaEl = `<img src="${first}" alt="" loading="lazy" />`;
        }

        const dateStr = it.date ? new Date(it.date).toLocaleDateString() : '';
        const pin = it.pinned ? `<span class="pin">Pinned</span>` : '';

        return `
          <div>
            <div class="card">
              ${mediaEl}
              ${pin}
            </div>
            <div class="meta">${it.name || ''}${dateStr ? ' • ' + dateStr : ''}</div>
          </div>
        `;
      }).join('');
    }

    platformSelect.addEventListener('change', render);
    refreshBtn.addEventListener('click', fetchItems);

    // initial load
    fetchItems();
  </script>
</body>
</html>
