<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Feed View</title>
<style>
  :root{
    --gap: 14px;          /* tighten/loosen grid gaps */
    --radius: 14px;       /* card rounding */
    --shadow: 0 6px 20px rgba(0,0,0,.08);
    --hoverShadow: 0 10px 24px rgba(0,0,0,.12);
    --bg: #fafafa;
    --card: #ffffff;
    --text: #111;
    --muted: #666;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.35 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  .wrap{max-width:1160px;margin:42px auto;padding:0 18px;}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;}
  h1{font-size:18px;margin:0;font-weight:700;}
  .controls{display:flex;gap:10px;align-items:center;}
  select,button{
    appearance:none;border:1px solid #e6e6e6;background:#fff;border-radius:10px;
    padding:10px 12px;font-weight:600;cursor:pointer;
  }
  button{display:inline-flex;align-items:center;gap:8px}
  button:hover{box-shadow:var(--shadow)}

  /* GRID — 3 columns, IG-style, 3:4 preview ratio */
  .grid{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--gap);
  }
  @media (max-width: 880px){ .grid{grid-template-columns:repeat(2,1fr);} }
  @media (max-width: 520px){ .grid{grid-template-columns:repeat(1,1fr);} }

  .card{
    background:var(--card);
    border-radius:var(--radius);
    overflow:hidden;
    box-shadow: var(--shadow);
    transition: transform .15s ease, box-shadow .15s ease;
    position:relative;
  }
  .card:hover{ transform: translateY(-3px); box-shadow: var(--hoverShadow); }

  /* Thumbnail box fixed to 3:4 aspect */
  .thumb{
    position:relative;
    width:100%;
    aspect-ratio: 3 / 4;
    background:#eee;
  }
  .thumb img,.thumb video,.thumb iframe{
    position:absolute; inset:0; width:100%; height:100%;
    object-fit: cover; border:0;
  }
  .badge{
    position:absolute; top:8px; left:8px;
    background:rgba(0,0,0,.6); color:#fff; font-size:12px; padding:4px 8px; border-radius:999px;
  }
  /* hover footer (hidden until hover) */
  .meta{
    position:absolute; left:0; right:0; bottom:0;
    padding:10px 12px; color:#fff; font-weight:600; font-size:12px;
    background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,.0) 20%, rgba(0,0,0,.55) 100%);
    opacity:0; transition:opacity .12s ease;
    display:flex; justify-content:space-between; gap:10px;
  }
  .card:hover .meta{ opacity:1; }

  /* Lightbox */
  .lightbox{
    position:fixed; inset:0; background:rgba(0,0,0,.72);
    display:none; align-items:center; justify-content:center; z-index:99;
    padding:24px;
  }
  .lightbox.open{ display:flex; }
  .lb-inner{
    width:min(100%, 980px); max-height:85vh; background:#000; border-radius:16px; overflow:hidden; position:relative;
    box-shadow:0 12px 40px rgba(0,0,0,.35);
  }
  .lb-stage{
    background:#000; position:relative; width:100%; height:min(85vh, calc(100vw * 4/3));
    display:flex; align-items:center; justify-content:center;
  }
  .lb-stage img,.lb-stage video,.lb-stage iframe{
    max-width:100%; max-height:85vh; width:auto; height:auto; object-fit: contain;
  }
  .lb-caption{
    color:#fff; font-size:13px; padding:12px 14px;
    display:flex; justify-content:space-between; gap:10px; background:rgba(0,0,0,.55);
  }
  .lb-close{
    position:absolute; top:10px; right:10px; width:40px; height:40px; border-radius:999px; border:0; cursor:pointer;
    background:rgba(255,255,255,.14); color:#fff; font-weight:900; font-size:18px;
  }
  .nav{
    position:absolute; top:50%; transform:translateY(-50%); width:48px; height:48px; border-radius:999px; border:0;
    background:rgba(255,255,255,.15); color:#fff; font-size:22px; cursor:pointer;
  }
  .nav.left{ left:12px; } .nav.right{ right:12px; }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Feed View</h1>
      <div class="controls">
        <label style="font-weight:700">Platform</label>
        <select id="platform">
          <option>All</option>
          <option>Instagram</option>
          <option>TikTok</option>
          <option>Pinterest</option>
          <option>Facebook</option>
          <option>Threads</option>
          <option>LinkedIn</option>
          <option>X</option>
        </select>
        <button id="refresh">⟳ Refresh</button>
      </div>
    </header>

    <div id="grid" class="grid"></div>
  </div>

  <!-- LIGHTBOX -->
  <div id="lightbox" class="lightbox">
    <div class="lb-inner">
      <button class="lb-close" title="Close" id="lbClose">×</button>
      <button class="nav left" id="lbPrev">‹</button>
      <button class="nav right" id="lbNext">›</button>
      <div class="lb-stage" id="lbStage"></div>
      <div class="lb-caption"><span id="lbName">—</span><span id="lbDate">—</span></div>
    </div>
  </div>

<script>
  const grid = document.getElementById('grid');
  const dd = document.getElementById('platform');
  const refreshBtn = document.getElementById('refresh');

  // Lightbox state
  let current = { list: [], index: 0 };
  const lb = document.getElementById('lightbox');
  const lbStage = document.getElementById('lbStage');
  const lbName = document.getElementById('lbName');
  const lbDate = document.getElementById('lbDate');
  document.getElementById('lbClose').onclick = () => lb.classList.remove('open');
  document.getElementById('lbPrev').onclick = () => showLB(current.index - 1);
  document.getElementById('lbNext').onclick = () => showLB(current.index + 1);
  lb.addEventListener('click', (e)=>{ if(e.target === lb) lb.classList.remove('open'); });

  // Canva embed normalizer
  function normalizeCanva(u){
    try{
      if(!u.includes("canva.com")) return u;
      if(u.includes("embed")) return u;
      const m = u.match(/canva\.com\/design\/([^\/?#]+)/i);
      if(m && m[1]) return `https://www.canva.com/design/${m[1]}/view?embed`;
      return u;
    }catch{ return u; }
  }

  function fmtDate(iso){
    if(!iso) return '';
    const d = new Date(iso);
    return d.toLocaleDateString(undefined, { month:'short', day:'numeric', year:'numeric' });
  }

  function cardThumbHtml(media){
    const m = media[0]; // first media for the preview
    if(!m) return '';
    if(m.type === 'video'){
      return `<video src="${m.url}" muted playsinline></video>
              <span class="badge">Video</span>`;
    }
    if(m.type === 'canva'){
      const src = normalizeCanva(m.url);
      return `<iframe src="${src}" sandbox="allow-scripts allow-same-origin allow-popups" referrerpolicy="strict-origin-when-cross-origin"></iframe>`;
    }
    return `<img src="${m.url}" alt="">`;
  }

  function render(items){
    grid.innerHTML = '';
    items.forEach((it, idx) => {
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <div class="thumb">${cardThumbHtml(it.media)}</div>
        <div class="meta"><span>${escapeHtml(it.name)}</span><span>${fmtDate(it.date)}</span></div>
      `;
      el.onclick = () => openLB(items, idx);
      grid.appendChild(el);
    });
  }

  function escapeHtml(s){ return (s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  async function load(){
    const platform = dd.value || 'All';
    const q = new URLSearchParams();
    if(platform && platform !== 'All') q.set('platform', platform);

    const r = await fetch(`/api/notion?${q.toString()}`);
    if(!r.ok){
      grid.innerHTML = `<div style="color:#b00;background:#fee;border:1px solid #fcc;padding:12px;border-radius:10px">Backend error: ${r.statusText}</div>`;
      return;
    }
    const data = await r.json();
    render(data.items || []);
  }

  refreshBtn.onclick = load;
  dd.onchange = load;
  load();

  // ---------- Lightbox ----------
  function openLB(list, index){
    current = { list, index };
    showLB(index);
    lb.classList.add('open');
  }
  function showLB(i){
    if(!current.list.length) return;
    if(i < 0) i = current.list.length - 1;
    if(i >= current.list.length) i = 0;
    current.index = i;

    const item = current.list[i];

    // build a linear media list: for canva keep single iframe, for images/videos use the first media for now
    const m = item.media[0];
    lbStage.innerHTML = '';
    if(m.type === 'video'){
      const v = document.createElement('video');
      v.src = m.url;
      v.controls = true; v.autoplay = true; v.playsInline = true;
      lbStage.appendChild(v);
    }else if(m.type === 'canva'){
      const f = document.createElement('iframe');
      f.src = normalizeCanva(m.url);
      f.allow = "fullscreen";
      f.setAttribute('sandbox','allow-scripts allow-same-origin allow-popups');
      f.referrerPolicy = "strict-origin-when-cross-origin";
      lbStage.appendChild(f);
    }else{
      const img = document.createElement('img');
      img.src = m.url;
      lbStage.appendChild(img);
    }

    lbName.textContent = item.name || '';
    lbDate.textContent = fmtDate(item.date) || '';
  }
</script>
</body>
</html>

