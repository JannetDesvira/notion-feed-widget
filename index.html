<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Notion Feed Widget</title>
  <style>
    :root{ --gap:8px; --tileR:10px; }
    *{ box-sizing:border-box }
    body{ margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:#fff; color:#111; }
    .toolbar{ display:flex; align-items:center; gap:10px; padding:12px; border-bottom:1px solid #eee; position:sticky; top:0; background:#fff; z-index:2; }
    select,button{ height:32px; border:1px solid #e3e3e3; background:#fafafa; border-radius:8px; padding:0 10px; font-size:14px; cursor:pointer; }
    .grid{ padding:12px; display:grid; grid-template-columns:repeat(3,1fr); gap:var(--gap); }
    .card{ position:relative; width:100%; padding-top:100%; border-radius:var(--tileR); overflow:hidden; background:#f2f2f2; cursor:pointer; }
    .media, .media iframe{ position:absolute; inset:0; width:100%; height:100%; }
    .media{ object-fit:cover; }
    .caption{ position:absolute; left:0; right:0; bottom:0; padding:8px 10px; color:#fff; font-size:12px; background:linear-gradient(180deg,rgba(0,0,0,0) 0, rgba(0,0,0,.55) 90%); opacity:0; transition:.18s ease; }
    .card:hover .caption{ opacity:1; }

    /* lightbox */
    .lightbox{ position:fixed; inset:0; background:rgba(0,0,0,.85); display:none; align-items:center; justify-content:center; z-index:9999; }
    .lightbox.open{ display:flex; }
    .lb-inner{ width:min(920px,92vw); max-height:92vh; display:flex; flex-direction:column; gap:10px; }
    .lb-head{ display:flex; align-items:center; justify-content:space-between; color:#fff; font-size:14px; }
    .viewer{ position:relative; background:#000; border-radius:12px; overflow:hidden; display:flex; align-items:center; justify-content:center; min-height:60vh; }
    .viewer .media, .viewer iframe{ max-width:100%; max-height:80vh; width:auto; height:auto; }
    .lb-controls{ position:absolute; inset:0; display:flex; align-items:center; justify-content:space-between; pointer-events:none; }
    .arrow{ pointer-events:auto; background:rgba(0,0,0,.5); border:none; color:#fff; width:40px; height:40px; border-radius:999px; cursor:pointer; font-size:18px; display:grid; place-items:center; margin:0 8px; }
    .close{ background:transparent; border:none; color:#fff; font-size:20px; cursor:pointer; }
  </style>
</head>
<body>
  <div class="toolbar">
    <label style="font-size:14px">Platform</label>
    <select id="platform">
      <option>All</option>
      <option>Instagram</option>
      <option>TikTok</option>
      <option>Pinterest</option>
    </select>
    <button id="refresh">⟳ Refresh</button>
  </div>

  <div id="grid" class="grid" aria-live="polite"></div>

  <!-- lightbox -->
  <div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-label="Media viewer">
    <div class="lb-inner">
      <div class="lb-head">
        <div id="lb-title"></div>
        <button class="close" id="lb-close" aria-label="Close">✕</button>
      </div>
      <div class="viewer" id="viewer">
        <div class="lb-controls">
          <button class="arrow" id="prev" aria-label="Previous">‹</button>
          <button class="arrow" id="next" aria-label="Next">›</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const grid = document.getElementById("grid");
    const platformSel = document.getElementById("platform");
    const refreshBtn = document.getElementById("refresh");

    // lightbox state
    const lb = document.getElementById("lightbox");
    const lbTitle = document.getElementById("lb-title");
    const lbClose = document.getElementById("lb-close");
    const viewer = document.getElementById("viewer");
    const prevBtn = document.getElementById("prev");
    const nextBtn = document.getElementById("next");
    let lbItems = []; let lbIndex = 0;

    const fmtDate = (iso) => {
      if (!iso) return "";
      try { return new Date(iso).toLocaleDateString(undefined,{month:"short",day:"numeric",year:"numeric"}); }
      catch { return ""; }
    };

    // --- smarter media detection ---
    const looksLikeCanva = (u) => /canva\.com/i.test(u);
    const looksLikeVideoByExt = (u) => /\.(mp4|webm|mov)(\?|$)/i.test(u);
    const looksLikeNotionFile = (u) => /notion-static|amazonaws|s3/i.test(u); // Notion signed files often have no extension

    function makeVideo(url, asThumb=false){
      const v = document.createElement("video");
      v.className = "media";
      v.src = url;
      v.playsInline = true;
      v.muted = true;
      v.loop = true;
      if (!asThumb) v.controls = true;
      // show a frame even if autoplay is blocked
      v.preload = "metadata";
      v.addEventListener("loadedmetadata", () => {
        try { v.currentTime = 0.1; } catch {}
        if (asThumb) { v.autoplay = true; v.muted = true; v.loop = true; v.play().catch(()=>{}); }
      });
      return v;
    }

    function makeImage(url){
      const img = document.createElement("img");
      img.className = "media";
      img.loading = "lazy";
      img.src = url;
      return img;
    }

    function makeCanvaIframe(url){
      const u = new URL(url, location.href);
      if (!u.searchParams.has("embed")) u.searchParams.set("embed","1");
      const ifr = document.createElement("iframe");
      ifr.src = u.toString();
      ifr.setAttribute("frameborder","0");
      ifr.setAttribute("allowfullscreen","true");
      ifr.style.pointerEvents = "none"; // clicking opens lightbox instead
      return ifr;
    }

    // pick best element for a URL (thumb vs lightbox)
    function mediaEl(url, {thumb=false} = {}){
      if (looksLikeCanva(url)) {
        return thumb ? makeCanvaIframe(url) : (() => {
          const a = document.createElement("a");
          a.href = url; a.target="_blank"; a.rel="noopener";
          a.style.color="#fff"; a.textContent="Open Canva design";
          a.style.padding="16px";
          return a;
        })();
      }
      if (looksLikeVideoByExt(url) || looksLikeNotionFile(url)) {
        return makeVideo(url, thumb);
      }
      return makeImage(url);
    }

    function renderLightbox(){
      viewer.innerHTML = "";
      const url = lbItems[lbIndex];
      const node = mediaEl(url, {thumb:false});
      viewer.appendChild(node);
      const multi = lbItems.length > 1;
      prevBtn.style.visibility = multi ? "visible" : "hidden";
      nextBtn.style.visibility = multi ? "visible" : "hidden";
    }

    function openLightbox(item){
      lbItems = item.media.slice();
      lbIndex = 0;
      lbTitle.textContent = `${fmtDate(item.date)} • ${item.name}`;
      renderLightbox();
      lb.classList.add("open");
    }

    lbClose.onclick = () => lb.classList.remove("open");
    prevBtn.onclick = () => { lbIndex = (lbIndex - 1 + lbItems.length) % lbItems.length; renderLightbox(); };
    nextBtn.onclick = () => { lbIndex = (lbIndex + 1) % lbItems.length; renderLightbox(); };
    lb.addEventListener("click", (e) => { if (e.target === lb) lb.classList.remove("open"); });

    async function fetchItems(){
      const url = new URL(location.href);
      const base = `${url.origin}${url.pathname.replace(/\/$/, "")}/api/notion`;
      const p = platformSel.value || "All";
      const api = `${base}?platform=${encodeURIComponent(p)}`;
      const r = await fetch(api, { cache:"no-store" });
      if (!r.ok) throw new Error(`Backend error ${r.status}`);
      return r.json();
    }

    function render(items){
      grid.innerHTML = "";
      if (!items?.length) return;

      items.forEach((it) => {
        const card = document.createElement("div");
        card.className = "card";

        const first = it.media[0] || "";
        const thumbNode = mediaEl(first, {thumb:true});
        card.appendChild(thumbNode);

        const cap = document.createElement("div");
        cap.className = "caption";
        cap.textContent = `${fmtDate(it.date)} • ${it.name}`;
        card.appendChild(cap);

        card.onclick = () => openLightbox(it);
        grid.appendChild(card);
      });
    }

    async function load(){
      try { const { items } = await fetchItems(); render(items); }
      catch(err){ grid.innerHTML = `<div style="color:#b00020;padding:12px;background:#fee;border-radius:8px;">${err.message}</div>`; }
    }

    // init from ?platform=
    (function syncFromQuery(){
      const q = new URLSearchParams(location.search);
      const qp = (q.get("platform") || "All").toLowerCase();
      for (const opt of platformSel.options) if (opt.value.toLowerCase() === qp) platformSel.value = opt.value;
    })();
    platformSel.onchange = () => { const q = new URLSearchParams(location.search); q.set("platform", platformSel.value); history.replaceState(null,"",`?${q}`); load(); };
    refreshBtn.onclick = load;

    load();
  </script>
</body>
</html>
